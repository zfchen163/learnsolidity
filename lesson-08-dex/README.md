# 第8课：去中心化交易所（DEX）💱

## 🎯 这一课你会学到

- 什么是 DEX（去中心化交易所）
- AMM（自动做市商）的原理
- 流动性池如何运作
- 如何交换代币

## 🤔 人话解释

### DEX = 自动兑换机

想象一个自动货币兑换机：

**传统交易所（CEX）**：
```
你 → 交易所 → 挂单 → 等待匹配 → 成交
```
- 需要信任交易所
- 交易所保管你的钱
- 可能跑路或被黑

**去中心化交易所（DEX）**：
```
你 → 智能合约 → 自动计算价格 → 立即成交
```
- 不需要信任任何人
- 你自己保管钱
- 代码公开透明

### AMM = 自动售货机

传统交易所像菜市场：

```
买家：我想买苹果，出价 5 元/斤
卖家：我想卖苹果，要价 6 元/斤
中间商：撮合成交，5.5 元/斤
```

AMM 像自动售货机：

```
流动性池：有 100 个苹果和 500 元
价格公式：价格 = 钱 / 苹果 = 5 元/斤
你买 10 个苹果 → 自动计算价格 → 立即成交
```

## 📐 核心公式

### 1. 恒定乘积公式（Uniswap V2）

```
x × y = k

x: 代币 A 的数量
y: 代币 B 的数量
k: 常数（不变）
```

**例子**：
```
初始状态：
100 个 ETH × 200,000 个 USDT = 20,000,000 (k)
价格：1 ETH = 2,000 USDT

有人买 10 个 ETH：
90 个 ETH × ? 个 USDT = 20,000,000
? = 222,222 USDT

需要支付：222,222 - 200,000 = 22,222 USDT
实际价格：22,222 / 10 = 2,222 USDT/ETH（比初始价格高）
```

### 2. 为什么价格会变？

```
买的越多 → 池子里的代币越少 → 价格越高
卖的越多 → 池子里的代币越多 → 价格越低
```

这就是**滑点**（Slippage）。

## 💧 流动性池

### 什么是流动性？

流动性就是池子里的钱：

```
流动性池 = 代币 A + 代币 B

例如：
100 ETH + 200,000 USDT
```

### 流动性提供者（LP）

任何人都可以往池子里加钱，成为 LP：

```
你存入：1 ETH + 2,000 USDT
你获得：LP 代币（证明你的份额）

收益：
- 交易手续费分成（通常 0.3%）
- 可能的无常损失
```

### 无常损失

如果价格变化，LP 可能亏钱：

```
初始：
存入 1 ETH + 2,000 USDT
ETH 价格 = 2,000 USDT

ETH 涨到 4,000 USDT：
如果持有：1 ETH + 2,000 USDT = 6,000 USDT
如果做 LP：约 5,657 USDT
无常损失：343 USDT（5.7%）
```

但是！手续费收益可能弥补损失。

## 🔄 交易流程

### 1. 添加流动性

```
用户 → 存入 100 ETH + 200,000 USDT
合约 → 铸造 LP 代币给用户
池子 → 储备增加
```

### 2. 交换代币

```
用户 → 用 1 ETH 换 USDT
合约 → 计算能换多少（扣除手续费）
合约 → 转出 USDT 给用户
池子 → ETH 增加，USDT 减少
```

### 3. 移除流动性

```
用户 → 销毁 LP 代币
合约 → 按比例返还 ETH 和 USDT
池子 → 储备减少
```

## 🚀 运行示例

```bash
cd lesson-08-dex
./run.sh
```

## 📊 预期输出

```
=== 💱 DEX 测试 ===

1️⃣  部署代币和 DEX
   代币A: TokenA (TKA)
   代币B: TokenB (TKB)
   DEX 合约: 0x5FbDB2...

2️⃣  添加初始流动性
   存入: 100 TKA + 200 TKB
   ✅ 流动性已添加
   LP 代币: 141.42...
   
   池子状态:
   储备A: 100 TKA
   储备B: 200 TKB
   价格: 1 TKA = 2 TKB

3️⃣  交换测试（A → B）
   输入: 10 TKA
   预期输出: ~18.18 TKB
   实际输出: 18.18 TKB
   ✅ 交换成功
   
   池子状态:
   储备A: 110 TKA
   储备B: 181.82 TKB
   新价格: 1 TKA = 1.65 TKB
   
   滑点: 9.1%

4️⃣  交换测试（B → A）
   输入: 20 TKB
   预期输出: ~10.84 TKA
   实际输出: 10.84 TKA
   ✅ 交换成功

5️⃣  移除流动性
   销毁: 50 LP 代币
   取回: 38.5 TKA + 63.6 TKB
   ✅ 流动性已移除

=== ✅ 测试完成 ===
```

## 🔑 关键概念

### 1. 滑点（Slippage）

```
预期价格 vs 实际价格的差异

小额交易：滑点小
大额交易：滑点大

例如：
买 1 ETH：滑点 0.1%
买 100 ETH：滑点 10%
```

### 2. 手续费

```
每笔交易收取 0.3% 手续费
手续费分给所有 LP

例如：
交易 1000 USDT
手续费：3 USDT
LP 分成：3 USDT
```

### 3. 价格影响

```
交易金额越大 → 价格影响越大

建议：
- 分批交易
- 使用聚合器
- 选择流动性大的池子
```

### 4. 套利

```
如果 DEX 价格 ≠ CEX 价格
套利者会：
- 在便宜的地方买
- 在贵的地方卖
- 赚取差价
- 使价格趋于一致
```

## 🎮 动手试试

1. **改变初始比例**：试试 1:1、1:3 的比例
2. **模拟大额交易**：看看滑点有多大
3. **添加功能**：
   - 滑点保护
   - 价格预言机
   - 闪电贷
4. **优化公式**：
   - Uniswap V3（集中流动性）
   - Curve（稳定币优化）

## ❓ 常见问题

**Q: DEX 比 CEX 好吗？**
A: 各有优劣：
- DEX：去中心化、透明、不需要 KYC
- CEX：流动性大、速度快、用户友好

**Q: 为什么要做 LP？**
A: 
- 赚取手续费（年化可能 10%-100%+）
- 支持项目
- 但要承担无常损失风险

**Q: 如何减少滑点？**
A: 
- 分批交易
- 选择流动性大的池子
- 使用聚合器（1inch、Matcha）
- 等待价格稳定

**Q: DEX 安全吗？**
A: 
- 合约风险：可能有 bug
- 前端风险：钓鱼网站
- 授权风险：恶意合约
建议：只用知名 DEX，小额测试

## 💡 著名的 DEX

### 1. Uniswap
- 最大的 DEX
- V2: 恒定乘积
- V3: 集中流动性

### 2. Curve
- 专注稳定币
- 低滑点
- 高资本效率

### 3. PancakeSwap
- BSC 上的 DEX
- Gas 费低
- 高 APY

### 4. SushiSwap
- Uniswap 的分叉
- 有治理代币
- 多链部署

## 🎯 总结

恭喜你完成了基础课程！🎉

你已经学会了：
- ✅ 区块链的基本原理
- ✅ 编写智能合约
- ✅ 用 Go 与合约交互
- ✅ 转账和余额查询
- ✅ 投票系统
- ✅ 创建代币（ERC20）
- ✅ 铸造 NFT（ERC721）
- ✅ 去中心化交易所

## 🚀 下一步学什么？

### 进阶主题
1. **DeFi 协议**：借贷（Aave）、衍生品
2. **DAO 治理**：提案、投票、执行
3. **跨链桥**：资产跨链转移
4. **Layer 2**：Rollup、侧链
5. **安全审计**：常见漏洞、防护措施

### 实战项目
1. **众筹平台**
2. **NFT 市场**
3. **借贷协议**
4. **链上游戏**
5. **社交代币**

---

💡 **记住**：DEX 就像自动兑换机，用数学公式自动定价！

继续学习，成为 Web3 开发者！🚀
