# 第4课：转账和余额查询 💸

## 🎯 这一课你会学到

- 如何在地址之间转账 ETH
- 查询任意地址的余额
- 理解 Wei、Gwei、ETH 的转换
- Gas 费的计算

## 🤔 人话解释

### 转账就像发红包

想象你要给朋友发微信红包：

```
你的钱包: 100 元
↓ (发红包 10 元)
朋友的钱包: +10 元
你的钱包: 90 元
```

在区块链上也是一样的：

```
你的地址: 10 ETH
↓ (转账 1 ETH + 0.001 ETH Gas费)
朋友的地址: +1 ETH
你的地址: 8.999 ETH
```

**关键区别**：
- 微信转账：微信公司记账，免费
- 区块链转账：全网矿工记账，要付 Gas 费

### 为什么要付 Gas 费？

Gas 费就像快递费：

- **寄快递**：你要付快递费给快递员
- **区块链转账**：你要付 Gas 费给矿工

Gas 费用于：
1. 奖励矿工打包交易
2. 防止垃圾交易攻击
3. 优先处理愿意付更多费用的交易

## 💰 单位转换

以太坊有不同的单位，就像人民币有"元、角、分"：

```
1 ETH = 1,000,000,000 Gwei = 1,000,000,000,000,000,000 Wei

就像：
1 元 = 10 角 = 100 分
```

**常用单位**：
- **Wei**：最小单位（像"分"）
- **Gwei**：Gas 价格常用（1 Gwei = 10^9 Wei）
- **ETH**：日常使用（1 ETH = 10^18 Wei）

**为什么这么大？**
- 方便精确计算
- 避免小数点
- 就像比特币的"聪"（1 BTC = 100,000,000 聪）

## 💻 代码实现

我们会创建一个简单的转账程序：

1. 查询多个地址的余额
2. 从账户 A 转账到账户 B
3. 计算 Gas 费用
4. 显示转账前后的余额变化

## 🚀 运行方式

```bash
cd lesson-04-transfer-balance
go run main.go
```

## 📊 预期输出

```
=== 💸 转账和余额查询 ===

1️⃣  连接以太坊节点
   ✅ 已连接到: http://localhost:8545
   链ID: 1337

2️⃣  账户信息
   账户A: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
   账户B: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
   
   初始余额:
   账户A: 10000.000000 ETH
   账户B: 10000.000000 ETH

3️⃣  转账 1 ETH 从 A 到 B
   ✅ 交易已发送
   交易哈希: 0xabc123...
   ⏳ 等待确认... 完成！
   
   Gas 信息:
   Gas 价格: 1.5 Gwei
   Gas 使用: 21000
   Gas 费用: 0.0000315 ETH
   
   转账详情:
   发送金额: 1.000000 ETH
   实际扣除: 1.0000315 ETH (含 Gas)

4️⃣  转账后余额
   账户A: 8998.9999685 ETH (减少 1.0000315 ETH)
   账户B: 10001.000000 ETH (增加 1.000000 ETH)
   
   ✅ 余额变化正确！

5️⃣  批量查询余额
   地址1: 9999.5 ETH
   地址2: 10001.0 ETH
   地址3: 10000.0 ETH
   总计: 29500.5 ETH

=== ✅ 测试完成 ===
```

## 🔑 关键概念

### 1. 交易结构

每笔转账都是一个交易（Transaction）：

```go
type Transaction struct {
    From:     地址  // 发送方
    To:       地址  // 接收方
    Value:    金额  // 转账金额
    Gas:      数量  // Gas 限制
    GasPrice: 价格  // Gas 价格
    Nonce:    序号  // 交易序号（防重放）
    Data:     数据  // 附加数据
}
```

### 2. Gas 计算

```
总费用 = Gas 使用量 × Gas 价格

例如：
Gas 使用: 21,000 (简单转账固定值)
Gas 价格: 50 Gwei
总费用 = 21,000 × 50 Gwei = 1,050,000 Gwei = 0.00105 ETH
```

**不同操作的 Gas 消耗**：
- 简单转账：21,000 Gas
- 合约调用：50,000 - 500,000 Gas
- 复杂合约：可能上百万 Gas

### 3. Nonce（随机数）

Nonce 是账户发送交易的序号：

```
账户A的交易历史:
Nonce 0: 转账给 B
Nonce 1: 调用合约
Nonce 2: 转账给 C
Nonce 3: 下一笔交易
```

**作用**：
- 防止重放攻击（同一笔交易被执行多次）
- 保证交易顺序
- 必须连续（不能跳过）

### 4. 余额查询

查询余额是免费的（不需要 Gas）：

```go
// 查询最新余额
balance, _ := client.BalanceAt(context.Background(), address, nil)

// 查询历史余额（指定区块）
balance, _ := client.BalanceAt(context.Background(), address, blockNumber)
```

## 🎮 动手试试

运行代码后，试试这些：

1. **改转账金额**：试试转 0.1 ETH、10 ETH
2. **多次转账**：连续转几笔，观察 Nonce 变化
3. **查询历史**：查询不同区块高度的余额
4. **计算手续费**：试试不同 Gas 价格的费用

## ❓ 常见问题

**Q: 转账失败了，Gas 费会退吗？**
A: 不会！Gas 费已经支付给矿工了。就像快递发出去了，即使收件人拒收，快递费也不退。

**Q: 如何设置合适的 Gas 价格？**
A: 
- 太低：交易可能一直不被打包
- 太高：浪费钱
- 建议：查看网络当前 Gas 价格，稍微高一点

**Q: 可以转账给自己吗？**
A: 可以！但要付 Gas 费，所以余额会减少。

**Q: 转账金额可以是小数吗？**
A: 可以！但在代码里要用 Wei 表示，避免浮点数精度问题。

**Q: 如果 Gas 不够怎么办？**
A: 交易会失败，但 Gas 费不退。要预估好 Gas Limit。

## 💡 最佳实践

### 1. 余额检查

转账前先检查余额：

```go
balance, _ := client.BalanceAt(ctx, from, nil)
if balance.Cmp(amount) < 0 {
    return errors.New("余额不足")
}
```

### 2. Gas 估算

使用 `EstimateGas` 估算需要多少 Gas：

```go
gasLimit, _ := client.EstimateGas(ctx, msg)
```

### 3. 错误处理

转账可能失败，要处理错误：

```go
tx, err := client.SendTransaction(ctx, signedTx)
if err != nil {
    log.Printf("转账失败: %v", err)
    return err
}
```

### 4. 等待确认

不要假设交易立即成功：

```go
receipt, err := bind.WaitMined(ctx, client, tx)
if err != nil {
    return err
}
if receipt.Status == 0 {
    return errors.New("交易失败")
}
```

## 🎯 下一课预告

现在你会转账了！下一课我们会学习：
- **投票系统**：理解智能合约的状态管理
- 如何存储复杂数据结构
- 如何实现权限控制
- 如何防止重复投票

---

💡 **记住**：转账就像发红包，但要付 Gas 费给矿工！
