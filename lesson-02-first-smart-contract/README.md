# 第2课：第一个智能合约 - 存钱罐 🏦

## 🎯 这一课你会学到

- 什么是智能合约（用自动售货机类比）
- 写第一个 Solidity 合约
- 在本地区块链上部署和测试

## 🤔 人话解释

### 智能合约 = 自动售货机

想象一个自动售货机：

```
你投入 5 元 → 按下按钮 → 自动掉出可乐
```

**传统方式**（需要信任）：
- 你把钱给店员
- 店员承诺给你可乐
- 如果店员不诚实，你就亏了

**智能合约方式**（不需要信任）：
- 你把钱投入机器
- 机器自动检查：钱够吗？有货吗？
- 条件满足 → 自动给你可乐
- 条件不满足 → 自动退钱

### 智能合约的特点

1. **自动执行**：不需要人工干预
2. **公开透明**：代码所有人都能看
3. **不可篡改**：部署后无法修改
4. **去中心化**：运行在区块链上，不受单一机构控制

## 💰 我们的第一个合约：存钱罐

功能很简单：
- 存钱进去
- 查看余额
- 取钱出来（只有主人可以）

就像一个电子存钱罐！

## 📝 Solidity 代码解释

Solidity 是写智能合约的编程语言，语法类似 JavaScript。

### 合约结构

```solidity
// 1. 版本声明
pragma solidity ^0.8.0;

// 2. 合约定义（类似 class）
contract PiggyBank {
    // 3. 状态变量（存储在区块链上）
    address public owner;
    uint256 public balance;
    
    // 4. 构造函数（创建合约时执行一次）
    constructor() {
        owner = msg.sender;
    }
    
    // 5. 函数（合约的功能）
    function deposit() public payable {
        // 存钱逻辑
    }
}
```

### 关键概念

**address**（地址）
- 就像银行账号
- 每个人都有一个唯一的地址
- 例如：`0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb`

**uint256**（无符号整数）
- 存储数字（不能是负数）
- 256 位，可以存很大的数
- 例如：余额、数量

**msg.sender**（消息发送者）
- 调用这个函数的人的地址
- 系统自动提供

**payable**（可支付）
- 这个函数可以接收以太币
- 就像自动售货机的投币口

**require**（要求）
- 检查条件
- 条件不满足就回滚（撤销所有操作）
- 就像自动售货机检查"钱够不够"

## 💻 代码实现

我们会创建三个文件：
1. `PiggyBank.sol` - 智能合约
2. `deploy.js` - 部署脚本
3. `run.sh` - 一键运行

## 🚀 运行方式

```bash
cd lesson-02-first-smart-contract
./run.sh
```

这个脚本会：
1. 启动本地区块链（Ganache）
2. 编译智能合约
3. 部署到本地链
4. 测试存钱、取钱功能
5. 显示结果

## 📊 预期输出

```
=== 启动本地区块链 ===
✅ Ganache 已启动在 http://127.0.0.1:8545

=== 编译智能合约 ===
✅ PiggyBank.sol 编译成功

=== 部署合约 ===
📝 合约地址: 0x5FbDB2315678afecb367f032d93F642f64180aa3
👤 主人地址: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266

=== 测试存钱罐 ===

1️⃣ 初始余额
   存钱罐余额: 0 ETH

2️⃣ 存入 1 ETH
   ✅ 存款成功！
   交易哈希: 0xabc123...
   存钱罐余额: 1 ETH

3️⃣ 再存入 0.5 ETH
   ✅ 存款成功！
   存钱罐余额: 1.5 ETH

4️⃣ 主人取出所有钱
   ✅ 取款成功！
   取出金额: 1.5 ETH
   存钱罐余额: 0 ETH

5️⃣ 非主人尝试取钱
   ❌ 失败：只有主人可以取钱！

=== 测试完成 ===
```

## 🔑 关键概念

### 1. 以太币单位

```
1 ETH = 1,000,000,000,000,000,000 Wei
1 ETH = 1,000,000,000 Gwei
```

- **Wei**：最小单位（像"分"）
- **Gwei**：常用于 Gas 费
- **ETH**：以太币（像"元"）

### 2. 交易（Transaction）

每次调用合约函数都是一笔交易：

```
交易包含：
- from: 谁发起的
- to: 发给谁（合约地址）
- value: 转多少钱
- data: 调用什么函数
- gas: 愿意支付多少"电费"
```

### 3. Gas（燃料费）

运行合约需要消耗计算资源，需要支付 Gas 费：

```
Gas 费 = Gas 用量 × Gas 价格
```

- 就像开车需要汽油
- 越复杂的操作，消耗越多 Gas
- 防止有人写死循环攻击网络

### 4. 权限控制

```solidity
require(msg.sender == owner, "只有主人可以取钱");
```

这行代码确保只有主人能取钱，其他人会被拒绝。

## 🎮 动手试试

运行代码后，试试这些：

1. **改存款金额**：试试存 2 ETH、0.1 ETH
2. **添加功能**：加一个"查看存了几次钱"的计数器
3. **改权限**：试试让其他人也能取钱（不安全！）

## ❓ 常见问题

**Q: 智能合约部署后真的不能改吗？**
A: 对！一旦部署，代码就固定了。所以要非常小心 bug。有些合约会设计"升级模式"，但那是高级话题。

**Q: 如果合约有 bug，钱会丢吗？**
A: 可能！历史上有很多合约被黑客攻击。所以要：
- 仔细测试
- 代码审计
- 从小金额开始

**Q: 为什么要用 Solidity？不能用 Python 吗？**
A: Solidity 是专门为以太坊设计的。其他链可能用其他语言（如 Rust、Move）。

**Q: 本地区块链和真实区块链有什么区别？**
A: 
- 本地：只有你自己，免费，快速，用于开发测试
- 真实：全世界的人，要花真钱，慢一些，用于生产环境

## 🎯 下一课预告

现在你会写智能合约了！下一课我们会学习：
- **用 Go 连接智能合约**
- 从 Go 程序调用合约函数
- 监听合约事件

---

💡 **记住**：智能合约就是运行在区块链上的自动售货机！
